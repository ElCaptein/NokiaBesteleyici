<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nokia 3220 Master - PC & iOS Ready</title>
    <style>
        :root { --nokia-screen: #94b411; --nokia-dark: #2b3003; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: #000; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Courier New', monospace; }

        .phone {
            background: #1a1a1a; width: 320px; height: 95vh; max-height: 750px;
            border-radius: 50px 50px 100px 100px; border: 4px solid #333;
            padding: 15px; display: flex; flex-direction: column; align-items: center;
            position: relative; box-shadow: 0 0 50px #000; z-index: 5;
        }

        .screen-frame { background: #000; width: 100%; height: 32%; padding: 6px; border-radius: 8px; border: 2px solid #444; margin-top: 5px; }
        .screen { background: var(--nokia-screen); width: 100%; height: 100%; color: var(--nokia-dark); padding: 8px; display: flex; flex-direction: column; position: relative; }
        #display-text { font-size: 11px; font-weight: bold; flex: 1; word-break: break-all; overflow-y: auto; line-height: 1.1; margin-top: 5px; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; width: 100%; margin: 10px 0; }
        .btn-ctrl { background: #222; color: white; border: 1px solid #444; padding: 10px; border-radius: 6px; font-size: 9px; cursor: pointer; font-weight: bold; }
        .btn-ctrl:active { background: #444; }

        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 100%; flex: 1; }
        .key { background: #0a0a0a; color: #eee; border-radius: 12px; border: 1px solid #222; cursor: pointer; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 3px #000; }
        .key.active { background: #333; transform: translateY(2px); box-shadow: 0 1px #000; }
        .key span { font-size: 7px; color: #555; }

        .side-glow { position: absolute; width: 30px; height: 60%; border-radius: 40px; filter: blur(25px); opacity: 0; transition: 0.05s; z-index: 1; }
        #glowL { left: -40px; top: 15%; } #glowR { right: -40px; top: 15%; }
        #rec-dot { color: #d00; font-weight: bold; display: none; position: absolute; right: 8px; top: 20px; font-size: 10px; }
    </style>
</head>
<body onkeydown="handleKeyboard(event)">

<div id="glowL" class="side-glow"></div>
<div id="glowR" class="side-glow"></div>

<div class="phone">
    <div style="color:#555; font-size:9px; margin-bottom:5px;">NOKIA 3220 PRO-SYNC</div>
    <div class="screen-frame">
        <div class="screen">
            <div style="display: flex; justify-content: space-between; font-size: 9px; border-bottom: 1px solid">
                <span>MONO V4</span> <span id="speed-label">2.0x</span> <span>üì∂üîã</span>
            </div>
            <div id="rec-dot">‚óè REC</div>
            <div id="song-label" style="font-size: 9px; font-weight: bold; margin: 4px 0;">HAZIR</div>
            <div id="display-text">KLAVYE (1-9) VEYA EKRANA TIKLAYARAK SESƒ∞ A√áIN</div>
            <div style="font-size: 8px; border-top: 1px solid; padding-top:2px; margin-top: auto;">
                <span id="cur-len">S√ºre: 8</span> | <span id="cur-oct">Okt: 2</span>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn-ctrl" onclick="nextSong()">K√úT√úPHANE ‚ùØ</button>
        <button class="btn-ctrl" onclick="playMelody()" style="background:#1b4d1a">‚ñ∂ OYNAT</button>
        <button class="btn-ctrl" onclick="stop()">‚ñ† DUR</button>
        <button class="btn-ctrl" onclick="exportWav()" style="background:#4d1a1a">üíæ WAV AKTAR</button>
        <button class="btn-ctrl" onclick="clearAll()" style="grid-column: span 2;">TEMƒ∞ZLE</button>
    </div>

    <div class="keypad">
        <button class="key" id="key-c" onclick="handleKey('c')">1<span>do</span></button>
        <button class="key" id="key-d" onclick="handleKey('d')">2<span>re</span></button>
        <button class="key" id="key-e" onclick="handleKey('e')">3<span>mi</span></button>
        <button class="key" id="key-f" onclick="handleKey('f')">4<span>fa</span></button>
        <button class="key" id="key-g" onclick="handleKey('g')">5<span>sol</span></button>
        <button class="key" id="key-a" onclick="handleKey('a')">6<span>la</span></button>
        <button class="key" id="key-b" onclick="handleKey('b')">7<span>si</span></button>
        <button class="key" id="key-len" onclick="cycleLength()">8<span>s√ºre</span></button>
        <button class="key" id="key-oct" onclick="cycleOctave()">9<span>oktav</span></button>
        <button class="key" id="key-sharp" onclick="addSharp()">*<span>#</span></button>
        <button class="key" id="key-p" onclick="handleKey('p')">0<span>es</span></button>
        <button class="key" id="key-speed" onclick="nextSpeed()">#<span>hƒ±z</span></button>
    </div>
</div>

<script>
    let audioCtx;
    let isPlaying = false;
    let activeOscs = [];
    let melody = [];
    let speed = 2.0;
    let currentLength = 8;
    let currentOctave = 2;

    const library = [
        { name: "TURKISH MARCH", notes: ["8b1","8a1","8g#1","8a1","4c2","8p","8d2","8c2","8b1","8c2","4e2","8p","8f2","8e2","8d#2","8e2","8b2","8a2","8g#2","8a2","8b2","8a2","8g#2","8a2","4c3","8p","8a2","8g2","8f#2","8g2","4b2","8p","8a2","8g2","8f#2","8g2","4b2","8p","8d2","8c2","8b1","8c2","4e2","8p","8f2","8e2","8d#2","8e2","2a2"] },
        { name: "NOKIA TUNE", notes: ["8e2","8d2","4f#1","4g#1","8b1","8a1","4c#1","4e1","8f#1","8e1","4g#0","4b0","2e1"] },
        { name: "MISSION IMP", notes: ["16g1","16g1","16a#1","16c2","16g1","16g1","16f1","16f#1"] },
        { name: "AXEL F", notes: ["8g1","8a#1","8g1","16g1","8c2","8g1","8f1","8g1","8d2","8g1","16g1","8d#2","8d2","8a#1","8g1","8d2","8g2","16g1","8f1","16f1","8d1","8a1","2g1"] },
        { name: "KICK VIBE", notes: ["16e2","32e2","32e2","8e2","16d2","32d2","32d2","8d2","16c2","16g1"] },
        { name: "BOND 007", notes: ["4c1","8d1","8d1","4d1","2d1","4c1","4c1","4c1","4c1","8d#1","8d#1","2d#1","4d1","4d1","4d1"] },
        { name: "HABABAM", notes: ["4c2","8d2","8c2","4b1","4a1","4g1","4a1","4b1","2c2"] }
    ];
    let libIdx = -1;

    const freqs = {'c':261.63, 'c#':277.18, 'd':293.66, 'd#':311.13, 'e':329.63, 'f':349.23, 'f#':369.99, 'g':392.00, 'g#':415.30, 'a':440.00, 'a#':466.16, 'b':493.88, 'p':0};

    // iOS ve PC i√ßin AudioContext Kilidini A√ßan Fonksiyon
    function wakeAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    // Donanƒ±m Seviyesinde Ses Temizliƒüi (√úst √ºste binmeyi √∂nler)
    function clearHardware() {
        activeOscs.forEach(osc => { try { osc.stop(); osc.disconnect(); } catch (e) {} });
        activeOscs = [];
    }

    // Klavye Desteƒüi
    function handleKeyboard(e) {
        const keyMap = {
            '1':'c', '2':'d', '3':'e', '4':'f', '5':'g', '6':'a', '7':'b', '0':'p',
            '8':'len', '9':'oct', '*':'sharp', '#':'speed'
        };
        const val = keyMap[e.key];
        if (!val) return;
        
        // G√∂rsel efekt i√ßin butonu bul
        let btnId = (val === 'len' || val === 'oct' || val === 'sharp' || val === 'speed') ? `key-${val}` : `key-${val}`;
        if(document.getElementById(btnId)) {
            const btn = document.getElementById(btnId);
            btn.classList.add('active');
            setTimeout(() => btn.classList.remove('active'), 100);
        }

        if(['c','d','e','f','g','a','b','p'].includes(val)) handleKey(val);
        else if(val === 'len') cycleLength();
        else if(val === 'oct') cycleOctave();
        else if(val === 'sharp') addSharp();
        else if(val === 'speed') nextSpeed();
    }

    async function playTone(freq, duration, targetNode, isKey = false) {
        wakeAudio();
        if (freq === 0) return new Promise(r => setTimeout(r, duration * 1000));
        
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = 'square'; // Monofonik keskin dalga
        gain.gain.setValueAtTime(isKey ? 0.05 : 0.08, audioCtx.currentTime);
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        
        osc.connect(gain);
        gain.connect(targetNode || audioCtx.destination);
        
        osc.start();
        activeOscs.push(osc);
        
        if (!isKey) flashGlow();

        return new Promise(r => {
            setTimeout(() => { try { osc.stop(); } catch(e) {} r(); }, duration * 1000);
        });
    }

    async function playMelody(targetNode = null) {
        if (isPlaying) stop();
        await new Promise(r => setTimeout(r, 100));
        
        if (melody.length === 0) return;
        isPlaying = true;
        
        for (let item of melody) {
            if (!isPlaying) break;
            let m = item.match(/(\d+)([a-g,p]#?)(\d)/);
            if (!m) continue;
            let freq = freqs[m[2]] * Math.pow(2, parseInt(m[3]) - 1);
            let duration = (4.0 / parseInt(m[1])) / speed;
            await playTone(freq, duration, targetNode);
        }
        isPlaying = false;
    }

    async function exportWav() {
        if (melody.length === 0) return;
        wakeAudio();
        const dest = audioCtx.createMediaStreamDestination();
        const recorder = new MediaRecorder(dest.stream);
        const chunks = [];
        
        document.getElementById('rec-dot').style.display = 'block';
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `nokia_ringtone.wav`; a.click();
            document.getElementById('rec-dot').style.display = 'none';
        };
        recorder.start();
        await playMelody(dest);
        recorder.stop();
    }

    function stop() { isPlaying = false; clearHardware(); document.querySelectorAll('.side-glow').forEach(g => g.style.opacity = "0"); }

    function handleKey(n) {
        wakeAudio();
        let f = freqs[n] * Math.pow(2, currentOctave - 1);
        playTone(f, 0.1, null, true); 
        melody.push(`${currentLength}${n}${currentOctave}`);
        updateDisplay();
    }

    function nextSong() {
        stop();
        libIdx = (libIdx + 1) % library.length;
        melody = [...library[libIdx].notes];
        document.getElementById('song-label').innerText = "MELODƒ∞: " + library[libIdx].name;
        updateDisplay();
    }

    function updateDisplay() { document.getElementById('display-text').innerText = melody.join(' '); }
    
    function cycleLength() {
        const ls = [1, 2, 4, 8, 16, 32];
        currentLength = ls[(ls.indexOf(currentLength) + 1) % ls.length];
        document.getElementById('cur-len').innerText = "S√ºre: " + currentLength;
    }

    function cycleOctave() {
        currentOctave = (currentOctave % 3) + 1;
        document.getElementById('cur-oct').innerText = "Okt: " + currentOctave;
    }

    function addSharp() {
        if (!melody.length) return;
        let last = melody[melody.length-1];
        if (!last.includes('#') && !last.includes('p')) {
            melody[melody.length-1] = last.replace(/([a-g])/, '$1#');
            updateDisplay();
        }
    }

    function clearAll() { stop(); melody = []; updateDisplay(); }

    function nextSpeed() {
        const lvls = [1.0, 1.5, 2.0, 3.0];
        speed = lvls[(lvls.indexOf(speed) + 1) % lvls.length];
        document.getElementById('speed-label').innerText = speed.toFixed(1) + "x";
    }

    function flashGlow() {
        const l = document.getElementById('glowL'), r = document.getElementById('glowR');
        l.style.opacity = r.style.opacity = "1";
        const c = ["#ff0","#0f0","#f0f","#0ff","#f00"][Math.floor(Math.random()*5)];
        l.style.backgroundColor = r.style.backgroundColor = c;
        setTimeout(() => { if(isPlaying) l.style.opacity = r.style.opacity = "0.2"; }, 80);
    }
</script>
</body>
</html>
